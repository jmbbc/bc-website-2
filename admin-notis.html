<!DOCTYPE html>
<html class="light" lang="ms">
<head>
  <meta charset="utf-8" />
  <meta content="width=device-width, initial-scale=1.0" name="viewport" />
  <title>Admin Notis | Banjaria Court</title>
  <script src="https://cdn.tailwindcss.com?plugins=forms,container-queries"></script>
  <link href="https://fonts.googleapis.com/css2?family=Manrope:wght@300;400;500;600;700;800&display=swap" rel="stylesheet" />
  <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:wght,FILL@100..700,0..1&display=swap" rel="stylesheet" />
  <script id="tailwind-config">
    tailwind.config = {
      darkMode: "class",
      theme: {
        extend: {
          colors: {
            "primary": "#4A6741",
            "accent-warm": "#D4A373",
            "cream": "#FDFCF8",
            "stone-surface": "#F5F2EB",
            "text-main": "#2C3333",
          },
          fontFamily: { display: ["Manrope", "sans-serif"] },
          borderRadius: { "2xl": "1.5rem", "3xl": "2rem" },
          boxShadow: { soft: '0 10px 30px rgba(0,0,0,0.06)' }
        },
      },
    }
  </script>
  <style>
    body { font-family: 'Manrope', sans-serif; }
    .sidebar-collapsed { width: 4.5rem; }
    .sidebar-collapsed .nav-label { display: none; }
    .sidebar-collapsed .section-title { display: none; }
    .sidebar-collapsed .nav-link { justify-content: center; padding-left: 0.75rem; padding-right: 0.75rem; }
    .sidebar-collapsed .collapse-chevron { transform: rotate(180deg); }
    .nav-link.active { background-color: rgba(74, 103, 65, 0.12); color: #4A6741; border: 1px solid rgba(74, 103, 65, 0.25); }
        /* line-clamp fallback utilities */
        .line-clamp-1 { display: -webkit-box; -webkit-line-clamp: 1; -webkit-box-orient: vertical; overflow: hidden; }
        .line-clamp-2 { display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden; }
  </style>
</head>
<body class="bg-cream text-text-main">
  <div class="min-h-screen flex bg-cream">
    <aside id="adminSidebar" class="w-72 shrink-0 border-r border-stone-200 bg-white/80 backdrop-blur-md shadow-soft transition-all duration-300">
      <div class="p-5 flex items-center justify-between">
        <div class="flex items-center gap-3">
          <div class="bg-primary text-white p-2 rounded-xl">
            <span class="material-symbols-outlined">dashboard</span>
          </div>
          <div class="leading-tight nav-label">
            <p class="text-xs font-bold uppercase tracking-[0.2em] text-primary">Admin</p>
            <h2 class="text-base font-bold text-text-main">Panel</h2>
          </div>
        </div>
        <button data-sidebar-toggle class="p-2 rounded-lg border border-stone-200 hover:bg-stone-50" aria-label="Toggle sidebar">
          <span class="material-symbols-outlined text-base collapse-chevron">menu_open</span>
        </button>
      </div>
      <div class="px-3 pb-6 space-y-4">
        <p class="section-title text-xs font-semibold uppercase tracking-[0.2em] text-text-main/60 px-3">Navigasi</p>
        <nav class="space-y-1" id="navLinks">
          <button data-page="home" class="nav-link flex w-full items-center gap-3 px-4 py-2.5 rounded-xl text-sm font-semibold text-text-main hover:bg-primary/10 hover:text-primary transition-colors" type="button">
            <span class="material-symbols-outlined text-base">home</span>
            <span class="nav-label">Utama</span>
          </button>
          <button data-page="notis-public" class="nav-link flex w-full items-center gap-3 px-4 py-2.5 rounded-xl text-sm font-semibold text-text-main hover:bg-primary/10 hover:text-primary transition-colors" type="button">
            <span class="material-symbols-outlined text-base">feed</span>
            <span class="nav-label">Papan Notis</span>
          </button>
          <button data-page="kemudahan" class="nav-link flex w-full items-center gap-3 px-4 py-2.5 rounded-xl text-sm font-semibold text-text-main hover:bg-primary/10 hover:text-primary transition-colors" type="button">
            <span class="material-symbols-outlined text-base">calendar_month</span>
            <span class="nav-label">Kemudahan</span>
          </button>
          <button data-page="komuniti" class="nav-link flex w-full items-center gap-3 px-4 py-2.5 rounded-xl text-sm font-semibold text-text-main hover:bg-primary/10 hover:text-primary transition-colors" type="button">
            <span class="material-symbols-outlined text-base">groups</span>
            <span class="nav-label">Komuniti</span>
          </button>
          <button data-page="laporan" class="nav-link flex w-full items-center gap-3 px-4 py-2.5 rounded-xl text-sm font-semibold text-text-main hover:bg-primary/10 hover:text-primary transition-colors" type="button">
            <span class="material-symbols-outlined text-base">description</span>
            <span class="nav-label">Laporan AGM/EGM</span>
          </button>
          <button data-page="tender" class="nav-link flex w-full items-center gap-3 px-4 py-2.5 rounded-xl text-sm font-semibold text-text-main hover:bg-primary/10 hover:text-primary transition-colors" type="button">
            <span class="material-symbols-outlined text-base">gavel</span>
            <span class="nav-label">Tender</span>
          </button>
          <button data-page="vendor" class="nav-link flex w-full items-center gap-3 px-4 py-2.5 rounded-xl text-sm font-semibold text-text-main hover:bg-primary/10 hover:text-primary transition-colors" type="button">
            <span class="material-symbols-outlined text-base">store</span>
            <span class="nav-label">Vendor</span>
          </button>
          <button data-page="portal" class="nav-link flex w-full items-center gap-3 px-4 py-2.5 rounded-xl text-sm font-semibold text-text-main hover:bg-primary/10 hover:text-primary transition-colors" type="button">
            <span class="material-symbols-outlined text-base">fact_check</span>
            <span class="nav-label">Portal Borang</span>
          </button>
          <button data-page="hubungi" class="nav-link flex w-full items-center gap-3 px-4 py-2.5 rounded-xl text-sm font-semibold text-text-main hover:bg-primary/10 hover:text-primary transition-colors" type="button">
            <span class="material-symbols-outlined text-base">support_agent</span>
            <span class="nav-label">Hubungi</span>
          </button>
        </nav>
        <p class="section-title text-xs font-semibold uppercase tracking-[0.2em] text-text-main/60 px-3 pt-2">Sesi</p>
        <nav class="space-y-1">
          <button id="resetSampleBtn" class="nav-link w-full flex items-center gap-3 px-4 py-2.5 rounded-xl text-sm font-semibold text-text-main hover:bg-primary/10 hover:text-primary transition-colors" type="button">
            <span class="material-symbols-outlined text-base">restart_alt</span>
            <span class="nav-label">Reset Notis Contoh</span>
          </button>
          <button id="logoutBtn" class="nav-link w-full flex items-center gap-3 px-4 py-2.5 rounded-xl text-sm font-semibold text-text-main hover:bg-primary/10 hover:text-primary transition-colors" type="button">
            <span class="material-symbols-outlined text-base">logout</span>
            <span class="nav-label">Log Keluar</span>
          </button>
        </nav>
      </div>
    </aside>

    <div class="flex-1 flex flex-col">
      <header class="sticky top-0 z-30 bg-cream/95 backdrop-blur-md border-b border-stone-200/70">
        <div class="max-w-6xl mx-auto px-6 py-4 flex items-center justify-between">
          <div class="flex items-center gap-3">
            <button data-sidebar-toggle class="lg:hidden p-2 rounded-lg border border-stone-200 hover:bg-white" aria-label="Toggle sidebar">
              <span class="material-symbols-outlined text-base">menu</span>
            </button>
            <div class="bg-primary text-white p-2 rounded-xl">
              <span class="material-symbols-outlined">campaign</span>
            </div>
            <div>
              <p class="text-xs font-bold uppercase tracking-[0.2em] text-primary">Panel Admin</p>
              <h1 class="text-lg font-bold text-text-main">Urus Notis</h1>
            </div>
          </div>
          <a class="text-sm font-semibold text-primary flex items-center gap-1 hover:underline" href="halaman_notis_kediaman.html">
            <span class="material-symbols-outlined text-base">visibility</span>
            Lihat Papan Notis
          </a>
        </div>
      </header>

      <main class="flex-1 w-full px-4 sm:px-6 py-8">
        <div id="notisAdminLayout" class="max-w-6xl mx-auto">
          <section class="bg-white rounded-3xl border border-stone-200 shadow-soft p-6 lg:p-8">
            <div class="flex flex-col md:flex-row md:items-center md:justify-between gap-3 mb-6">
              <div>
                <p class="text-xs font-bold uppercase tracking-[0.2em] text-primary">Notis (Admin)</p>
                <h2 class="text-2xl font-extrabold">Notis Semasa</h2>
              </div>
              <div class="flex flex-wrap items-center gap-3 text-sm text-text-main/70">
                <span class="px-3 py-1 bg-primary/10 text-primary rounded-full border border-primary/20" id="notisCount"></span>
                <button id="resetSampleBtn" class="inline-flex items-center gap-2 px-3 py-1.5 rounded-lg border border-stone-200 text-text-main hover:bg-stone-50 text-sm font-semibold">
                  <span class="material-symbols-outlined text-base">restart_alt</span>
                  Reset Notis Contoh
                </button>
              </div>
            </div>
            <div id="notisList" class="grid gap-4 md:grid-cols-2"></div>
          </section>
        </div>

        <div id="pagePreviewLayout" class="hidden max-w-6xl mx-auto">
          <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-4 mb-6">
            <div>
              <p class="text-xs font-bold uppercase tracking-[0.2em] text-primary">Pratonton Kandungan</p>
              <h2 id="previewTitle" class="text-2xl font-extrabold">Halaman</h2>
              <p id="previewSubtitle" class="text-sm text-text-main/60 mt-1">Senarai kad pada halaman terpilih.</p>
            </div>
            <div class="flex items-center gap-3">
              <span id="previewCount" class="text-sm text-text-main/60"></span>
              <button id="addItemBtn" class="text-xs font-bold text-primary bg-primary/10 px-3 py-2 rounded-lg border border-primary/20 hover:bg-primary/15 inline-flex items-center gap-1">
                <span class="material-symbols-outlined text-base">add</span>
                Tambah Baharu
              </button>
              <button id="resetPageBtn" class="text-xs font-bold text-primary bg-primary/10 px-3 py-2 rounded-lg border border-primary/20 hover:bg-primary/15">
                Reset Halaman
              </button>
            </div>
          </div>

          <div id="previewCards" class="grid gap-3 md:grid-cols-2 lg:grid-cols-3"></div>
          <p id="previewEmpty" class="hidden text-sm text-text-main/60">Tiada kad untuk dipaparkan.</p>
        </div>
      </main>
    </div>
  </div>

  <template id="notisCardTemplate">
    <article class="border border-stone-200 rounded-2xl p-4 lg:p-5 bg-white flex flex-col gap-3">
      <div class="flex items-center justify-between gap-2">
        <div class="flex items-center gap-3">
          <div class="w-10 h-10 rounded-xl bg-primary/10 text-primary flex items-center justify-center">
            <span class="material-symbols-outlined">campaign</span>
          </div>
          <div>
            <p class="text-xs font-semibold uppercase tracking-widest text-text-main/60 card-category"></p>
            <h3 class="text-lg font-bold card-title"></h3>
          </div>
        </div>
        <p class="text-sm text-text-main/60 card-date"></p>
      </div>
      <p class="text-sm text-text-main/70 card-summary"></p>
      <div class="flex items-center gap-2 pt-2">
        <button class="edit-btn inline-flex items-center gap-1 text-primary text-sm font-bold hover:underline">
          <span class="material-symbols-outlined text-base">edit</span>
          Sunting
        </button>
        <button class="delete-btn inline-flex items-center gap-1 text-red-600 text-sm font-bold hover:underline">
          <span class="material-symbols-outlined text-base">delete</span>
          Padam
        </button>
      </div>
    </article>
  </template>

  <script>
    const authKey = 'adminAuthed';

    if (localStorage.getItem(authKey) !== 'true') {
      window.location.href = 'admin.html';
    }

    const defaultNotices = [
      { id: crypto.randomUUID(), title: 'Gangguan Bekalan Air Sementara', category: 'Penyelenggaraan', date: '2023-10-15', summary: 'Kerja pembaikan paip utama di Blok A akan dijalankan 9:00 pagi - 5:00 petang.', image: 'https://lh3.googleusercontent.com/aida-public/AB6AXuCTq7zizUdokZtsDQ6oljg1rEGo5VCLDYUNvre8k2dREHncdAYwlk2zI6q36VQH6QdBzc9yH6LQeF_xXJqZn87Qq6KHlK02FMxyFj9pB8NQQZwysSGtqtmzG3O0sp7cy2nVRBQ5LkuGnnbQ_l__WETLiESavJODz3hpyexbAi5gOmH80mZ0rRjjtucK74NvAjx_OdeulP1H5nRfGF7V8W8In6jY0z8ge572QwO2_5dP0_1HodK1da7Zogefklpy7_w2YwgzP7Wu6ms' },
      { id: crypto.randomUUID(), title: 'Mesyuarat Agung Tahunan (AGM)', category: 'Umum', date: '2023-11-20', summary: 'Kehadiran semua pemilik dialu-alukan bagi membincangkan pelantikan jawatankuasa baharu.', image: 'https://lh3.googleusercontent.com/aida-public/AB6AXuCZlde0qucjpnWS2USosfkdBHEPOK04fdmmJtgJ9Klne2MmdplzoekKtMm3LHd8CM87Oz-IjiT7HGsAa8d9RYPAss9d-i15OLCeYVwjibDB1iEQMyBpPOvnZRJY7MPu0OC-UWzz4jLEEfeVPd5F88i3-ic-E5ZmepYABuVxYC5uLBBtEM8Bh5ZF1GB93qoQalqSahMmTL9zlBb4VRpzwEJ_4ivjNttYuiqOTQtykazN3ukGUr9JNIjFZwf63wQ2NKj_3zfsnrIYZBU' },
      { id: crypto.randomUUID(), title: 'Projek Keceriaan Taman', category: 'Aktiviti', date: '2023-10-10', summary: 'Penambahan landskap di zon rekreasi Fasa 2 dengan lebih banyak pokok teduhan.', image: 'https://lh3.googleusercontent.com/aida-public/AB6AXuBf0rGKwyX_iC3P1-Wc39R5EEJAfP1jaYX4tQO9fgK5kCGHCjp2PkMf1FdioZqWp6A_lfYwc2FSVwbgfv2Sax0Qb7-NYwVO8_CHGah-hjVG5KlvtzQ4_SyotxReLj-p6PtfpJKNIu0XR6nhJN8YcfyarAkdJ4rJ92Ey26QykGEwsfsJnFuzptgbJY3FJ_9c8huccxawmi2BgvTablywrrhGcpg_rrT5r4M3zxr6SAevNhGYVTgWfzk4yiF0LHHESpXJ8iMVNeRropY' },
      { id: crypto.randomUUID(), title: 'Sistem Kawalan Akses Baru', category: 'Keselamatan', date: '2023-11-01', summary: 'Pendaftaran tag akses baru penduduk bermula di pejabat pengurusan.', image: 'https://lh3.googleusercontent.com/aida-public/AB6AXuBbfEskiQBAxLiVOcjapuEgoS16VXD4-uk9BCrnQ7_wDq04opPovDxb6hcpEUON26_ok2yWSFOXEv9YF6AI6kHYRJEuvBBLtIiPinKiBM09g1j9XbGW0Fh4UkuKPkdJJwOwYSGHSsE38waiNNiU8VWZ_rnphivokBTkxk8jOsgbkvCqHYTIi9aOPYRHli2ecFZ-Ni4G7u5IPJULCqrbYpXPMTMvUjF49XVzj1xfqBiluaOwBhVvgBtO2P_60pA07mzZWmpuHn46rQ0' },
      { id: crypto.randomUUID(), title: 'Program Gotong-Royong Perdana', category: 'Aktiviti', date: '2023-10-25', summary: 'Bersih kawasan parkir dan taman permainan; sarapan disediakan.', image: 'https://lh3.googleusercontent.com/aida-public/AB6AXuDJebI2EZjeAHw-ft6KmwaQ0r2m5AAfPVHO7CDFOOydQdDz1BlvXEx7A9Yyepprtt9C0fv0eaRG4thsflo5wMdDuTtNxSalrddxq7hpBWVJEB7ZK-yziV5iVRb1UPVpD3-FAA7aQ9ItWeORMK_YMnHUMcvTT6P3jqxh8J3sTsC3pIYn-J9mQtF3sEATN6cH8Q1Lcla22SYD0Hd-iIHzVthqvbNH1iS9fAVDMJlmQrktDBRg6WBpYkuIH3wn4zx9H4XB9YCi421a4Ww' },
      { id: crypto.randomUUID(), title: 'Yuran Penyelenggaraan Suku Ke-4', category: 'Kewangan', date: '2023-10-05', summary: 'Peringatan pembayaran yuran; pembayaran atas talian disediakan.', image: 'https://lh3.googleusercontent.com/aida-public/AB6AXuA4SIiqaxGYZwT5HkiW-d5bwy4NbtyWuDjLj-wiled35KhkzzqFJpF8fUr4fkZFyYs9Ma0ATVkUbHWgJCkdIgrO_FK-IXQEgRZzJAhqkekZZV-X9UoGztNgD1I_uL1D0G1eBERs55dh4c0BdmXgWPpYGGf-gC2owfruqpyp_LOTGyammdu4_1902HPbCPBIIzCLofQBVy2NIAJJ_fvTiPXxYfyHgApXUqyrQ3uHAAzb7farLJOgh91J1L03qTWX8Ywnmd6fRu1sVv4' },
    ];

    let dataService;
    let notices = [];
    let currentPage = 'home';

    function seedWithIds(obj) {
      const copy = {};
      Object.keys(obj).forEach(key => {
        copy[key] = {
          title: obj[key].title,
          subtitle: obj[key].subtitle,
          cards: (obj[key].cards || []).map(c => ({ ...c, id: crypto.randomUUID() })),
        };
      });
      return copy;
    }

    const pageDefaults = {
      'home': {
        title: 'Utama',
        subtitle: 'Kad hero dan hab penduduk di halaman utama.',
        cards: [
          { tag: 'Hero', title: 'Selamat Datang ke Banjaria Court', summary: 'Highlight kediaman hijau dan ajakan “Lihat Kemudahan” & “Pendaftaran Pelawat”.', bg: 'bg-gradient-to-r from-primary/10 to-accent-warm/10' },
          { tag: 'Hab Penduduk', title: 'Kumpulan servis utama', summary: 'Notis, Tempahan, Pembayaran, Sokongan sebagai pintu masuk utama.' },
        ],
      },
      'kemudahan': {
        title: 'Kemudahan',
        subtitle: 'Kad tempahan & fasiliti.',
        cards: [
          {
            tag: 'Rekreasi',
            title: 'Kolam Renang Infinit',
            summary: 'Ketenangan air yang menyegarkan dengan sistem penapisan kristal; pemandangan panorama.',
            image: 'https://lh3.googleusercontent.com/aida-public/AB6AXuCZKYxYXMiV-d_YYekDkZxChjplGQLnlzqGY3ZWGLQDJ92ocpjjnCmfSu9IUFLr_ium4kCnTxzUYgUHTmjoxkvpfQiVJuNJ4g9n3m8dbpdHv4AXr6j4UOECEhE7CzutpUqTFr9CrsWB7RBjYLQOnQaKxSvtdqt8kra_pqwfKLPHr5TPamqp3szwiSj-WrdzAgjDW-cjLjptb-P1Io8d5R0se8KKbmaKSiSDppGZh4FPcpb8CR3asBcL8qvG_yJqL_tYCPMVy0A6mr4',
            meta: '7:00 pagi - 10:00 malam',
            badge: 'Popular',
            icon: 'pool',
          },
          {
            tag: 'Keluarga',
            title: 'Taman Permainan',
            summary: 'Permukaan lembut EPDM dan peralatan moden untuk si kecil bermain selamat.',
            image: 'https://lh3.googleusercontent.com/aida-public/AB6AXuDGiVvRWkVNjFLKUN9fm2FpzNhpwRnFsf_cGgNigQGLmF6R3hvXpcqwfbgBxYTHsOhgLe1OJGTZKhpxYF61ZZf1MtfMcGST4VecegAs6VCCwJOxX_LnBLpPiYpek9lTGjUr7yKEA3yYriUMEqP0HJCbYva4pcL74XkOu9AgadiawTKhv50DkdJUJJ4jcm6Uxw-bISrrHlVA9wA08ZcElfQadqpwDc9hIMALNySMTQjjOiGD6HYw-vJq1J9c7ly_JzKSokmOSkv7Snk',
            meta: '8:00 pagi - 8:00 malam',
            icon: 'child_care',
          },
          {
            tag: 'Kesihatan',
            title: 'Laman Refleksologi',
            summary: 'Zon herba aromatik untuk terapi minda & fizikal; sesuai meditasi.',
            image: 'https://lh3.googleusercontent.com/aida-public/AB6AXuC8EELoZ5XNpT8EGP3fZIRNyrHQV44Kv36cK9eK9CoMHXmM4uvYY-KsWc1pQBwJhX7p6q7iuk2EyBFPYsDDX5pWaWSbEklN2I1cY5MNuuvTpBgdsIoRVQ7nG1iGbhaeEgol9gMuk0n8cyKfV7L7_4JQ52hqpTfh2xr3uI5tbNHsywKsM63Uc_aNyp3Y-AulAK9AL-hFxhkbxedLGOv8S1uRFqPrJKNncsNsChcjFzLGYqPNSHPZEg77pdLWXLrvWGB3ZPcyyJdan3U',
            meta: 'Sentiasa terbuka',
            icon: 'spa',
          },
          {
            tag: 'Komuniti',
            title: 'Dewan Serbaguna',
            summary: 'Ruang berhawa dingin untuk kenduri, mesyuarat dan acara komuniti.',
            image: 'https://lh3.googleusercontent.com/aida-public/AB6AXuDeoURgF7cm7nhfkYTjZvPipQ8yvQIf7QVbTy2FmfqqJ5waJzaPIJIp6ujgWBv0Y6jjGpZTXizfJoM-8w14bA0eJOvPLVlq3Zs5kT9Kgm_5w1vPOYtSHPss8h5-wRliimEL9fOXi9H4gTZeOR4damVtJ2o6DCJjS1jj8EQAYyIeedDQ2dzRvjysSduMMgoXPO9saWv24XeU1ye_WQ4ZIrxCemLVL4cc0eCUE5-82rYxXwLa2gHPXzGiUg61kwNPvOocv_pdboFOzIg',
            meta: 'Perlu tempahan',
            icon: 'groups',
          },
          {
            tag: 'Sukan',
            title: 'Gimnasium Terbuka',
            summary: 'Peralatan senaman luaran diselenggara rapi di tengah kehijauan.',
            image: 'https://lh3.googleusercontent.com/aida-public/AB6AXuCxsfo_wWEah62mZZweTwRGycmOI77Tb-V7p3LuRb1aUvURnNusqawr0y5TtuP7GO2-SU7eqp0v6oznUp4wGCqpEDiRjRwKONpdW3I_I5KbYxjnFmxz1-_JkZd9cQwSHsFRSDxirKOSwjUrOukifI8XNrquAZj6RgNpkUD-FHBnL2XXU50zG1LcOcfD5pupe9rgfkwy6Ptq7Bmoa5UT65isnmabCvw77LR1moVgKTs-wt9qbR2gc-yk1sAbltd_SiLTuNTPLoXxcN0',
            meta: '6:00 pagi - 11:00 malam',
            icon: 'fitness_center',
          },
          {
            tag: 'Santai',
            title: 'Kawasan BBQ',
            summary: 'Kemudahan memanggang lengkap berhampiran kolam; sesuai untuk keluarga.',
            image: 'https://lh3.googleusercontent.com/aida-public/AB6AXuBUlod-KivcxvepGvTgwP9XWTSEWEWa5cLXvsixMwJ_OmgOWLXTXScyZpKXAxoiTfoG6BmSoeul7aGQfV8I6kC4RN0QaFr1t5XHlrACpRBuMPGXLmwfHOzGyIr4qdZtI0pR3HDhRXM5hlwlIXrolJaXYw35H5edxtUGaa5ScwxCMxFBbGTBFCkY6D5UwCOidRAKJ4PPic0Ys263IUE63X-C_mc0MltBrXH9lsyEB1JvbldfD_GG5fLhb4Z1hTSVevb-SuXbr0sQokE',
            meta: 'Tempahan diperlukan',
            icon: 'outdoor_grill',
          },
        ],
      },
      'komuniti': {
        title: 'Aktiviti Komuniti',
        subtitle: 'Kad acara komuniti.',
        cards: [
          { tag: 'Akan Datang', title: 'Gotong-royong Perdana & Taman Herba', date: '2024-08-12', summary: 'Bersih kawasan blok & perasmian taman herba.' },
          { tag: 'Sukan', title: 'Liga Futsal Komuniti', summary: 'Pertandingan santai hujung minggu.' },
          { tag: 'Perayaan', title: 'Jamuan Hari Raya Blok B', summary: 'Jamuan bersama jiran tetangga.' },
        ],
      },
      'laporan': {
        title: 'Laporan AGM/EGM',
        subtitle: 'Sorotan laporan terkini.',
        cards: [
          { tag: 'AGM', title: 'Minit Mesyuarat Agung Tahunan Ke-15', date: '2024-05-25', summary: 'Status: Disahkan oleh JMB • Menunggu audit akhir.', meta: '2.4 MB', icon: 'article' },
          { tag: 'Kewangan', title: 'Laporan Kewangan Tahunan 2023', date: '2024-03-12', summary: 'Laporan penuh audit kewangan tahun berakhir 2023.', meta: '4.1 MB', icon: 'account_balance' },
          { tag: 'EGM', title: 'Minit Mesyuarat Agung Luar Biasa (EGM)', date: '2024-01-10', summary: 'Perbincangan: Penukaran Lif Blok B dan Isu Parkir.', meta: '1.8 MB', icon: 'gavel' },
        ],
      },
      'tender': {
        title: 'Tender Terbuka',
        subtitle: 'Ringkasan tender aktif.',
        cards: [
          { tag: 'Penyelenggaraan', title: 'Pengecatan Semula Blok A & Blok B', date: '2025-01-15', summary: 'Kerja cat luar dan dalaman blok A & B, termasuk pemeriksaan retakan.', meta: 'TDR-2025-001' },
          { tag: 'Naik Taraf', title: 'Naiktaraf Sistem Lif (Fasa 2)', date: '2024-12-30', summary: 'Penggantian komponen kritikal lif dan sistem kecemasan.', meta: 'TDR-2024-017' },
          { tag: 'Keselamatan', title: 'Perkhidmatan Kawalan Keselamatan 2024', date: '2024-10-20', summary: 'Kontrak pengawal 24/7 dan rondaan parkir bertingkat.', meta: 'TDR-2024-010' },
          { tag: 'Landskap', title: 'Landskap & Penanaman Semula Pokok', date: '2024-11-22', summary: 'Penanaman semula pokok teduhan dan pembaikan sistem pengairan.', meta: 'TDR-2024-021' },
          { tag: 'Penyelenggaraan', title: 'Penggantian Paip Utama Blok C', date: '2024-11-05', summary: 'Penggantian paip utama air domestik dan ujian tekanan.', meta: 'TDR-2024-013' },
        ],
      },
      'vendor': {
        title: 'Vendor Berdaftar',
        subtitle: 'Direktori vendor.',
        cards: [
          { name: 'Syarikat Paip Jitu', category: 'Paip', icon: 'plumbing', rating: 4.8, reviews: 120, phone: '+60 12-345 6789', years: 12, verified: true, whatsapp: 'https://wa.me/60123456789', profileUrl: '#' },
          { name: 'Arus Elektrik Enterprise', category: 'Elektrik', icon: 'bolt', rating: 4.5, reviews: 85, phone: '+60 13-987 6543', years: 8, verified: true, whatsapp: 'https://wa.me/60139876543', profileUrl: '#' },
          { name: 'CoolAir Solutions', category: 'Penyaman Udara', icon: 'ac_unit', rating: 4.9, reviews: 200, phone: '+60 17-555 1234', years: 15, verified: true, whatsapp: 'https://wa.me/60175551234', profileUrl: '#' },
          { name: 'CleanHome Services', category: 'Pembersihan', icon: 'cleaning_services', rating: 4.7, reviews: 50, phone: '+60 11-232 4455', years: 5, verified: false, whatsapp: 'https://wa.me/60112324455', profileUrl: '#' },
          { name: 'BuildRight Reno', category: 'Renovasi', icon: 'format_paint', rating: 4.6, reviews: 90, phone: '+60 19-333 4444', years: 10, verified: true, whatsapp: 'https://wa.me/60193334444', profileUrl: '#' },
          { name: 'PlumbMaster Pro', category: 'Baik Pulih', icon: 'construction', rating: 4.4, reviews: 75, phone: '+60 14-221 3322', years: 6, verified: false, whatsapp: 'https://wa.me/60142213322', profileUrl: '#' },
        ],
      },
      'portal': {
        title: 'Portal Borang Digital',
        subtitle: 'Borang & permohonan.',
        cards: [
          { title: 'Permit Renovasi', description: 'Mohon pengubahsuaian atau pembaikan unit.', icon: 'construction', url: '#', highlight: false },
          { title: 'Tempahan Fasiliti', description: 'BBQ Pit, Gelanggang atau Dewan.', icon: 'calendar_month', url: '#facility-booking', highlight: true },
          { title: 'Notis Pindah', description: 'Jadualkan logistik masuk atau keluar.', icon: 'local_shipping', url: '#', highlight: false },
          { title: 'Kad Akses', description: 'Mohon kad baharu atau gantian.', icon: 'badge', url: '#', highlight: false },
        ],
      },
      'hubungi': {
        title: 'Hubungi Pengurusan',
        subtitle: 'Saluran komunikasi.',
        cards: [
          {
            title: 'Pejabat Pengurusan',
            icon: 'location_on',
            lines: [
              'Banjaria Court Management Office',
              'Jalan Samudera Utama',
              '68100 Batu Caves, Selangor',
            ],
            highlight: false,
            extra: { label: 'Telefon', value: '+603 6188 1234' },
          },
          {
            title: 'Waktu Operasi',
            icon: 'schedule',
            lines: [
              'Isnin - Jumaat: 9:00 pagi - 5:00 petang',
              'Sabtu: 9:00 pagi - 1:00 petang',
              'Ahad: Tutup',
            ],
            highlight: true,
          },
          {
            title: 'Hotline Sekuriti (24/7)',
            icon: 'shield_lock',
            lines: ['+603 6188 5678'],
            highlight: false,
          },
          {
            title: 'Emel Pengurusan',
            icon: 'alternate_email',
            lines: ['management@banjaria.com', 'Respon dalam 1 hari bekerja'],
            highlight: false,
          },
        ],
      },
    };

    dataService = createLocalDataService();
    notices = dataService.loadNotices();
    pageData = dataService.loadPages();

    function ensureNoticeIds() {
      let touched = false;
      notices = (notices || []).map(n => {
        if (!n.id) {
          touched = true;
          return { ...n, id: crypto.randomUUID() };
        }
        return n;
      });
      if (touched) dataService.saveNotices(notices);
    }

    function ensureNoticeData() {
      // Reseed jika tiada notis langsung
      if (!Array.isArray(notices) || notices.length === 0) {
        notices = defaultNotices.map(n => ({ ...n, id: crypto.randomUUID() }));
        dataService.saveNotices(notices);
      }
      ensureNoticeIds();
    }

    function ensureAllPageIds() {
      Object.keys(pageData || {}).forEach(key => ensurePageCardIds(key));
    }

    function ensurePageCardIds(pageName) {
      const entry = pageData[pageName];
      if (!entry) return;

      // Jika data disimpan sebagai array, tukar kepada shape { title, subtitle, cards }
      if (Array.isArray(entry)) {
        pageData[pageName] = {
          title: pageDefaults[pageName]?.title || pageName,
          subtitle: pageDefaults[pageName]?.subtitle || '',
          cards: entry,
        };
      }

      const target = pageData[pageName];
      if (!target || !Array.isArray(target.cards)) return;

      let touched = false;
      target.cards = target.cards.map(c => {
        if (!c.id) {
          touched = true;
          return { ...c, id: crypto.randomUUID() };
        }
        return c;
      });
      if (touched) {
        dataService.savePages(pageData);
      }
    }

    function ensurePageEntry(pageName) {
      const defaults = pageDefaults[pageName];
      const existing = pageData[pageName];

      // Jika tiada entri langsung, reseed dari defaults
      if (!existing) {
        if (!defaults) return;
        pageData[pageName] = seedWithIds({ [pageName]: defaults })[pageName];
        dataService.savePages(pageData);
        return;
      }

      // Jika cards tiada atau bukan array atau kosong, reseed dari defaults
      if (!existing.cards || !Array.isArray(existing.cards) || existing.cards.length === 0) {
        if (defaults) {
          pageData[pageName] = seedWithIds({ [pageName]: defaults })[pageName];
          dataService.savePages(pageData);
          return;
        }
      }

      // Pastikan id diset
      ensurePageCardIds(pageName);
    }

    function createLocalDataService() {
      const noticeKey = 'notices';
      const pageKey = 'pageDataV1';

      const normalizeEntry = (pageName, entry) => {
        if (Array.isArray(entry)) {
          return {
            title: pageDefaults[pageName]?.title || pageName,
            subtitle: pageDefaults[pageName]?.subtitle || '',
            cards: entry.map(c => ({ id: c.id || crypto.randomUUID(), ...c })),
          };
        }
        if (!entry || typeof entry !== 'object') {
          return { title: pageDefaults[pageName]?.title || pageName, subtitle: pageDefaults[pageName]?.subtitle || '', cards: [] };
        }
        entry.cards = (entry.cards || []).map(c => ({ id: c.id || crypto.randomUUID(), ...c }));
        return entry;
      };

      const safeParse = (raw, fallback, label) => {
        try {
          const parsed = JSON.parse(raw);
          if (parsed === null || typeof parsed !== 'object') throw new Error('Invalid shape');
          return parsed;
        } catch (err) {
          console.error(`Data parse error for ${label}`, err);
          showToast('Data rosak, kembali ke default.', 'error');
          return fallback;
        }
      };

      return {
        loadNotices() {
          const saved = localStorage.getItem(noticeKey);
            const ensureIds = (list) => {
              const withIds = (list || []).map(n => ({ ...n, id: n.id || crypto.randomUUID() }));
              localStorage.setItem(noticeKey, JSON.stringify(withIds));
              return withIds;
            };

            if (!saved) {
              return ensureIds(defaultNotices);
            }
            const parsed = safeParse(saved, defaultNotices, 'notices');
            if (!Array.isArray(parsed)) return ensureIds(defaultNotices);
            return ensureIds(parsed);
        },
        saveNotices(list) {
          localStorage.setItem(noticeKey, JSON.stringify(list));
        },
        resetNotices() {
          const seeded = defaultNotices.map(n => ({ ...n, id: crypto.randomUUID() }));
          localStorage.setItem(noticeKey, JSON.stringify(seeded));
          return seeded;
        },
        loadPages() {
          const saved = localStorage.getItem(pageKey);
          if (!saved) {
            const seeded = seedWithIds(pageDefaults);
            localStorage.setItem(pageKey, JSON.stringify(seeded));
            return seeded;
          }
          const parsed = safeParse(saved, seedWithIds(pageDefaults), 'page data');
          Object.keys(parsed).forEach(k => {
            parsed[k] = normalizeEntry(k, parsed[k]);
          });
          return parsed;
        },
        savePages(data) {
          localStorage.setItem(pageKey, JSON.stringify(data));
        },
        resetPage(pageName) {
          const seeded = seedWithIds({ [pageName]: pageDefaults[pageName] || { cards: [] } });
          const fresh = seeded[pageName] || { cards: [] };
          localStorage.setItem(pageKey, JSON.stringify({ ...this.loadPages(), [pageName]: fresh }));
          return fresh;
        }
      };
    }

    function showToast(message, variant = 'info') {
      if (!toastHost) return;
      const el = document.createElement('div');
      const base = 'min-w-[240px] max-w-sm rounded-2xl border px-4 py-3 shadow-lg shadow-primary/10 text-sm bg-white';
      const tone = variant === 'error'
        ? 'border-red-200 text-red-700 bg-red-50'
        : variant === 'success'
          ? 'border-emerald-200 text-emerald-800 bg-emerald-50'
          : 'border-stone-200 text-text-main bg-white';
      el.className = `${base} ${tone}`;
      el.textContent = message;
      toastHost.appendChild(el);
      setTimeout(() => {
        el.style.opacity = '0';
        el.style.transform = 'translateY(-4px)';
        el.style.transition = 'opacity 150ms ease, transform 150ms ease';
        setTimeout(() => el.remove(), 180);
      }, 3000);
    }

    function isValidUrl(value) {
      if (!value) return true;
      try {
        new URL(value);
        return true;
      } catch (_) {
        return false;
      }
    }

    function validateNotice(payload) {
      const errors = [];
      if (!payload.title || payload.title.length < 4) errors.push('Tajuk mesti ada sekurang-kurangnya 4 aksara.');
      if (!payload.summary || payload.summary.length < 10) errors.push('Ringkasan terlalu pendek.');
      if (!payload.date) errors.push('Tarikh diperlukan.');
      if (payload.image && !isValidUrl(payload.image)) errors.push('URL imej tidak sah.');
      return errors;
    }

    const toastHost = document.createElement('div');
    toastHost.className = 'fixed top-4 right-4 z-50 space-y-3';
    document.body.appendChild(toastHost);

    const sidebar = document.getElementById('adminSidebar');
    const sidebarToggles = document.querySelectorAll('[data-sidebar-toggle]');
    const navLinks = document.querySelectorAll('#navLinks .nav-link');
    const notisLayout = document.getElementById('notisAdminLayout');
    const previewLayout = document.getElementById('pagePreviewLayout');
    const previewTitle = document.getElementById('previewTitle');
    const previewSubtitle = document.getElementById('previewSubtitle');
    const previewCount = document.getElementById('previewCount');
    const previewCards = document.getElementById('previewCards');
    const previewEmpty = document.getElementById('previewEmpty');
    const resetPageBtn = document.getElementById('resetPageBtn');
    const compactGridClass = 'grid gap-3 md:grid-cols-2 lg:grid-cols-3';
    const noticeGridClass = 'grid gap-4 md:grid-cols-2';
    const fallbackImages = [
      'https://lh3.googleusercontent.com/aida-public/AB6AXuB0yW6o4DoAYcV7ml0A9UJXNP-zefOlqCSX2kjIvA06KHD4P_Ov6MT334kSkkk7UcKkQC3j8_LyRu4cvJdtqYkujTNYFkvl3BX6fXzxhR9dCtBv6HxjJjBnnIwB35Zny3osneBqBlvTNhf7MQYvXgXIoPjzDj3rBuvvv8Ge8--NRRej3AErRV6qDMC2GuLOMLK5-AaiC5cMb55juX0swUrwfd3A_dsPdp1XFEu0hPhJ3TePUs9T4RrKnzn4uWNWvJdw7Ttt1sA4Wts',
      'https://lh3.googleusercontent.com/aida-public/AB6AXuCqpEF2HztR3lHpXF6xUQnk1Kz_uME_OhCMnhX9KFKEcJ0fkfE-7_QT9cLh3v4yCzvcOCrT-xtGdzPEIn6hXze_jkW0zHTcRDLEBsK1NYa9DD_3JG3jCS1PNiST3hkpcKkz-mSfWj7haSw6zbkAnhLjTJ6xHL0rmEOKkQCLam-T29c4up6fMfAFTTrjshsFsQFHVoIm7OwEOV42hfDZ0J0JAGY_BcB2WOgpTqAUPvFb-XBP4QuoBh_cCI09GCz0xXjPkyww00l0M6c',
      'https://lh3.googleusercontent.com/aida-public/AB6AXuBkYkltb7C1HhoFW_sPq4ZhWROBVjha-fkQFtwrkaVmc6SX6QNg317VZtoQM7Jg1rm57_FNUTARTr2yHRjny3DvmwiTPr4hhPMcWQC323L0dcXPyTGOXj5nev2Zayo6kLfS6QZ0HrPPF1CCdH9uFcNieUOy6nR7EkWuuTUktP85Tr4YiLK2U1iY1LL2shApCLRfvWwx3XcRAxEiCbFxEMFowN4cEEyJZxatS1WI4tArZHLpISRlJk7Sfuw_LqPz5Y5DKZrFLPMm1dw',
      'https://lh3.googleusercontent.com/aida-public/AB6AXuB5Ewr544LMUBKephLgVR6hv9Q18OA2ZoxFM_5jptsaB_z7d2MH_2Wivm7h_iwQclM5_wF2JImG5g1aRKQgda1L3-la4jPOmxjEVoSIc7p3rPqHjG0WuUE25CD0OediwR8I5Ds2o-gD0zMnEziIQ7VS4czDG2LxyeScGU4wAGbqRYI2S8pB6D0DxVt-KooUTabzdXkICtIa53uYqQodkT1hS59tmXYSPYx1HK_2M9__LS_G86hajaHB8mnxikfx6kqFgXfRRXKNtCQ',
      'https://lh3.googleusercontent.com/aida-public/AB6AXuDPZLM_OI-zx4LWFIxCepL2nx34QL1in1P9021naRQVIRbqZfR-XzRi3ZFXw-xJjXPeDmtkp-wM6TsGQXUAVeu6_O2zdbgiTBbBWYzlb92fNMS9FxjQzkG5PhbfaMajLYiu9GnVczkfU5oJo3KNqpmtIFQ07oGRlaP1N7b1BGg4W9F_-yDdT8QX85ExJkchCdRtjdwEGFGtopHz3gFCVN_O9ApBBqFrJr0oTByfDWR7CaYgtTI564icXQIIW0wrd4jEq9jZXBXTnoo',
    ];

    const listEl = document.getElementById('notisList');
    const countEl = document.getElementById('notisCount');
    const resetSampleBtn = document.getElementById('resetSampleBtn');
    const logoutBtn = document.getElementById('logoutBtn');
    const addItemBtn = document.getElementById('addItemBtn');
    let editModal = document.getElementById('editModal');
    let editForm = document.getElementById('editForm');
    let editTitle = document.getElementById('editTitle');
    let editTag = document.getElementById('editTag');
    let editDate = document.getElementById('editDate');
    let editMeta = document.getElementById('editMeta');
    let editSummary = document.getElementById('editSummary');
    let editImage = document.getElementById('editImage');
    let editUpload = document.getElementById('editUpload');
    let editPreview = document.getElementById('editPreview');
    let editModalTitle = document.getElementById('editModalTitle');
    let editModalContext = document.getElementById('editModalContext');
    let editState = null;
    let editEventsBound = false;

    sidebarToggles.forEach(btn => btn.addEventListener('click', () => {
      sidebar.classList.toggle('sidebar-collapsed');
    }));

    navLinks.forEach(link => link.addEventListener('click', () => {
      const page = link.getAttribute('data-page');
      setActivePage(page);
    }));

    if (addItemBtn) {
      addItemBtn.addEventListener('click', () => {
        const isNotice = currentPage === 'notis-public';
        const newId = crypto.randomUUID();
        if (isNotice) {
          const today = new Date().toISOString().slice(0, 10);
          openEditModal('notice', 'notis-public', {
            id: newId,
            title: '',
            tag: '',
            rawDate: today,
            summary: '',
            meta: '',
            image: '',
          }, true);
        } else {
          const defaults = pageDefaults[currentPage] || {};
          openEditModal('page', currentPage, {
            id: newId,
            title: '',
            tag: defaults.title || currentPage,
            rawDate: '',
            summary: '',
            meta: '',
            image: '',
          }, true);
        }
      });
    }

    ensureNoticeData();
    ensureAllPageIds();
    renderNotices();
    setActivePage('home');

    // Notis form removed; Admin view now read-only grid.

    // Page card form removed per requirement.

    if (resetPageBtn) {
      resetPageBtn.addEventListener('click', () => {
        if (!confirm('Reset kandungan halaman ini kepada default?')) return;
        pageData[currentPage] = dataService.resetPage(currentPage);
        dataService.savePages(pageData);
        const isNoticePage = currentPage === 'notis-public' || currentPage === 'kemudahan';
        renderPageCards(currentPage, isNoticePage);
        showToast('Halaman telah di-reset.', 'success');
      });
    }

    resetSampleBtn.addEventListener('click', () => {
      if (!confirm('Gantikan notis dengan 6 contoh asal?')) return;
      notices = dataService.resetNotices();
      dataService.saveNotices(notices);
      renderNotices();
      setActivePage(currentPage);
      showToast('Notis contoh dipulihkan.', 'success');
    });

    logoutBtn.addEventListener('click', () => {
      localStorage.removeItem(authKey);
      window.location.href = 'admin.html';
    });

    function renderNotices() {
      ensureNoticeData();
      listEl.innerHTML = '';
      if (!notices.length) {
        listEl.innerHTML = '<p class="text-sm text-text-main/60">Tiada notis. Tambah notis baharu.</p>';
      }
      notices.forEach((notis, idx) => {
        const el = document.createElement('article');
        const imgSrc = notis.image || fallbackImages[idx % fallbackImages.length];
        const imageBlock = imgSrc ? `
            <div class="sm:w-40 h-40 sm:h-auto shrink-0 relative overflow-hidden">
              <div class="absolute inset-0 bg-cover bg-center" style="background-image: url('${imgSrc}')"></div>
              <div class="absolute top-3 left-3 sm:hidden">
                <span class="px-2 py-1 bg-white/90 backdrop-blur text-primary rounded-lg text-[11px] font-bold shadow-sm">${notis.category || ''}</span>
              </div>
            </div>
        ` : '';

        el.className = 'group bg-white rounded-2xl overflow-hidden border border-stone-200 hover:shadow-lg hover:shadow-primary/5 transition-all duration-300 flex flex-col sm:flex-row';
        el.innerHTML = `
            ${imageBlock}
            <div class="flex-1 p-5 flex flex-col justify-center gap-2">
              <div class="flex items-center gap-3 text-[11px] font-medium text-text-main/70">
                ${notis.date ? `<span class="text-eucalyptus font-bold text-sm">${formatDate(notis.date)}</span>` : ''}
                ${notis.date ? '<span class="w-1 h-1 rounded-full bg-[#cbd5e1]"></span>' : ''}
                <span class="text-[#60857d] uppercase tracking-wider">${notis.category || ''}</span>
              </div>
              <h3 class="text-lg font-bold text-text-main group-hover:text-primary transition-colors">${notis.title || ''}</h3>
              <p class="text-[#60857d] text-sm leading-relaxed line-clamp-2">${notis.summary || ''}
                ${notis.meta ? `<span class="block text-[11px] text-text-main/60 mt-1">${notis.meta}</span>` : ''}
              </p>
            </div>
        `;
        listEl.appendChild(el);
      });
      countEl.textContent = `${notices.length} notis`;
    }

    function deleteNoticeById(id) {
      const idx = notices.findIndex(n => n.id === id);
      if (idx === -1) return;
      notices.splice(idx, 1);
      dataService.saveNotices(notices);
      setActivePage('notis-public');
      showToast('Notis dipadam.', 'success');
    }

    function deletePageCardById(pageName, id) {
      if (!pageData[pageName] || !Array.isArray(pageData[pageName].cards)) return;
      const idx = pageData[pageName].cards.findIndex(c => c.id === id);
      if (idx === -1) return;
      pageData[pageName].cards.splice(idx, 1);
      dataService.savePages(pageData);
      setActivePage(pageName);
      showToast('Kad dipadam.', 'success');
    }

    function ensureEditModalReady() {
      if (!document.getElementById('editModal')) {
        const modalHtml = `
<div id="editModal" class="fixed inset-0 z-[60] hidden items-center justify-center px-4">
  <div class="absolute inset-0 bg-black/40 backdrop-blur-sm" data-edit-close></div>
  <div class="relative w-full max-w-2xl bg-white rounded-2xl shadow-2xl border border-stone-200 overflow-hidden">
    <div class="flex items-center justify-between px-6 py-4 border-b border-stone-200 bg-primary/5">
      <div>
        <p class="text-xs font-semibold text-primary uppercase tracking-widest" id="editModalContext">Edit</p>
        <h3 class="text-lg font-bold text-text-main" id="editModalTitle">Kemaskini</h3>
      </div>
      <button class="p-2 text-stone-500 hover:text-primary" data-edit-close>
        <span class="material-symbols-outlined">close</span>
      </button>
    </div>
    <form id="editForm" class="px-6 py-5 space-y-4">
      <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
        <label class="text-sm font-semibold text-text-main/80 space-y-1">
          <span>Tajuk</span>
          <input id="editTitle" type="text" class="w-full rounded-xl border border-stone-200 px-3 py-2 focus:outline-none focus:ring-2 focus:ring-primary/40" required minlength="3" />
        </label>
        <label class="text-sm font-semibold text-text-main/80 space-y-1">
          <span>Kategori / Tag</span>
          <input id="editTag" type="text" class="w-full rounded-xl border border-stone-200 px-3 py-2 focus:outline-none focus:ring-2 focus:ring-primary/40" />
        </label>
      </div>
      <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
        <label class="text-sm font-semibold text-text-main/80 space-y-1">
          <span>Tarikh (jika notis)</span>
          <input id="editDate" type="date" class="w-full rounded-xl border border-stone-200 px-3 py-2 focus:outline-none focus:ring-2 focus:ring-primary/40" />
        </label>
        <label class="text-sm font-semibold text-text-main/80 space-y-1">
          <span>Meta / Masa</span>
          <input id="editMeta" type="text" class="w-full rounded-xl border border-stone-200 px-3 py-2 focus:outline-none focus:ring-2 focus:ring-primary/40" />
        </label>
      </div>
      <label class="text-sm font-semibold text-text-main/80 space-y-1 block">
        <span>Ringkasan</span>
        <textarea id="editSummary" rows="3" class="w-full rounded-xl border border-stone-200 px-3 py-2 focus:outline-none focus:ring-2 focus:ring-primary/40" required minlength="5"></textarea>
      </label>
      <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
        <label class="text-sm font-semibold text-text-main/80 space-y-1">
          <span>URL Imej</span>
          <input id="editImage" type="url" class="w-full rounded-xl border border-stone-200 px-3 py-2 focus:outline-none focus:ring-2 focus:ring-primary/40" placeholder="https://" />
        </label>
        <label class="text-sm font-semibold text-text-main/80 space-y-1">
          <span>Muat naik imej</span>
          <input id="editUpload" type="file" accept="image/*" class="block w-full text-sm text-text-main/70" />
          <span class="text-[11px] text-text-main/60">Fail akan ditukar kepada data URL & disimpan bersama kad.</span>
        </label>
      </div>
      <div class="flex items-center gap-3">
        <div id="editPreview" class="size-24 rounded-xl border border-dashed border-stone-300 bg-stone-50 bg-center bg-cover"></div>
        <p class="text-xs text-text-main/60">Pratonton imej kad. Jika kosong, fallback akan digunakan.</p>
      </div>
      <div class="flex justify-end gap-3 pt-2">
        <button type="button" class="px-4 py-2 rounded-xl border border-stone-200 text-text-main hover:bg-stone-50" data-edit-close>Batal</button>
        <button type="submit" class="px-5 py-2 rounded-xl bg-primary text-white font-bold hover:bg-primary/90">Simpan</button>
      </div>
    </form>
  </div>
</div>`;
        document.body.insertAdjacentHTML('beforeend', modalHtml);
      }

      editModal = document.getElementById('editModal');
      editForm = document.getElementById('editForm');
      editTitle = document.getElementById('editTitle');
      editTag = document.getElementById('editTag');
      editDate = document.getElementById('editDate');
      editMeta = document.getElementById('editMeta');
      editSummary = document.getElementById('editSummary');
      editImage = document.getElementById('editImage');
      editUpload = document.getElementById('editUpload');
      editPreview = document.getElementById('editPreview');
      editModalTitle = document.getElementById('editModalTitle');
      editModalContext = document.getElementById('editModalContext');

      const ready = !!(editModal && editForm && editTitle && editTag && editDate && editMeta && editSummary && editImage && editUpload && editPreview && editModalTitle && editModalContext);
      if (!ready) return false;

      if (!editEventsBound) {
        editUpload.addEventListener('change', (e) => {
          const file = e.target.files && e.target.files[0];
          if (!file) return;
          const reader = new FileReader();
          reader.onload = (ev) => {
            const dataUrl = ev.target?.result;
            if (typeof dataUrl === 'string') {
              editImage.value = dataUrl;
              editPreview.style.backgroundImage = `url('${dataUrl}')`;
            }
          };
          reader.readAsDataURL(file);
        });

        editImage.addEventListener('input', () => {
          const url = editImage.value.trim();
          editPreview.style.backgroundImage = url ? `url('${url}')` : '';
        });

        editModal.querySelectorAll('[data-edit-close]').forEach(btn => {
          btn.addEventListener('click', closeEditModal);
        });

        editForm.addEventListener('submit', (evt) => {
          evt.preventDefault();
          if (!editState) return;
          const title = editTitle.value.trim();
          const tag = editTag.value.trim();
          const date = editDate.value;
          const summary = editSummary.value.trim();
          const meta = editMeta.value.trim();
          const image = editImage.value.trim();

          if (!title || summary.length < 5) {
            showToast('Lengkapkan tajuk dan ringkasan.', 'error');
            return;
          }
          if (editState.kind === 'notice' && !date) {
            showToast('Tarikh diperlukan untuk notis.', 'error');
            return;
          }

          if (editState.kind === 'notice') {
            if (editState.isNew) {
              const newNotice = { id: editState.id || crypto.randomUUID(), title, category: tag, date, summary, meta, image };
              notices.unshift(newNotice);
            } else {
              const idx = notices.findIndex(n => n.id === editState.id);
              if (idx === -1) return showToast('Notis tidak ditemui.', 'error');
              notices[idx] = { ...notices[idx], title, category: tag, date, summary, meta, image };
            }
            dataService.saveNotices(notices);
            setActivePage('notis-public');
            showToast(editState.isNew ? 'Notis ditambah.' : 'Notis dikemaskini.', 'success');
          } else {
            if (!pageData[editState.pageName]) {
              pageData[editState.pageName] = { title: pageDefaults[editState.pageName]?.title || editState.pageName, subtitle: pageDefaults[editState.pageName]?.subtitle || '', cards: [] };
            }
            const cards = pageData[editState.pageName].cards || [];
            if (editState.isNew) {
              const newCard = { id: editState.id || crypto.randomUUID(), title, tag, category: tag, summary, meta, image, date };
              cards.unshift(newCard);
            } else {
              const idx = cards.findIndex(c => c.id === editState.id);
              if (idx === -1) return showToast('Kad tidak ditemui.', 'error');
              cards[idx] = { ...cards[idx], title, tag, category: tag, summary, meta, image, date: date || cards[idx].date };
            }
            pageData[editState.pageName].cards = cards;
            dataService.savePages(pageData);
            setActivePage(editState.pageName);
            showToast(editState.isNew ? 'Kad baharu ditambah.' : 'Kad dikemaskini.', 'success');
          }

          closeEditModal();
        });

        editEventsBound = true;
      }

      return true;
    }

    function openEditModal(kind, pageName, card, isNew = false) {
      if (!ensureEditModalReady()) {
        showToast('Modal tidak tersedia. Sila refresh halaman.', 'error');
        return;
      }
      editState = { kind, pageName, id: card.id, isNew };
      editModalTitle.textContent = kind === 'notice' ? 'Edit Notis' : 'Edit Kad Halaman';
      editModalContext.textContent = pageName === 'notis-public' ? 'Papan Notis' : pageDefaults[pageName]?.title || pageName;
      editTitle.value = card.title || '';
      editTag.value = card.tag || card.category || '';
      editDate.value = kind === 'notice' && card.rawDate ? card.rawDate : '';
      editMeta.value = card.meta || '';
      editSummary.value = card.summary || '';
      editImage.value = card.image || '';
      editPreview.style.backgroundImage = card.image ? `url('${card.image}')` : '';
      editUpload.value = '';
      editModal.classList.remove('hidden');
      document.body.classList.add('overflow-hidden');
    }

    function closeEditModal() {
      editModal.classList.add('hidden');
      document.body.classList.remove('overflow-hidden');
      editState = null;
    }

    function setActivePage(page) {
      currentPage = page;
      navLinks.forEach(l => l.classList.toggle('active', l.getAttribute('data-page') === page));

      const useNoticeGrid = page !== 'notis-admin';
      previewCards.className = useNoticeGrid ? noticeGridClass : compactGridClass;

      notisLayout.classList.add('hidden');
      previewLayout.classList.remove('hidden');

      if (page === 'notis-public') {
        previewTitle.textContent = 'Papan Notis Umum';
        previewSubtitle.textContent = 'Kad notis seperti dilihat oleh penduduk.';
        ensureNoticeData();
        const noticeCards = (notices || []).map(n => ({
          id: n.id,
          tag: n.category,
          title: n.title,
          date: formatDate(n.date),
          rawDate: n.date,
          summary: n.summary,
          meta: n.meta,
          image: n.image,
        }));
        renderPreviewCards(noticeCards, true, true, 'notice');
        return;
      }

      ensurePageEntry(page);
      renderPageCards(page, true, 'page');
    }

    function renderPageCards(page, isNoticePage = false, actionMode = 'page') {
      ensurePageCardIds(page);
      const raw = pageData[page] || pageDefaults[page] || { title: 'Halaman', subtitle: '', cards: [] };
      const data = Array.isArray(raw) ? { title: pageDefaults[page]?.title || page, subtitle: pageDefaults[page]?.subtitle || '', cards: raw } : raw;
      const cards = (data.cards || []).map(c => ({
        id: c.id,
        tag: c.tag || c.category || c.icon || '',
        title: c.title || c.name || 'Kad',
        date: c.date ? formatDate(c.date) : '',
        rawDate: c.date || '',
        meta: c.meta,
        summary: c.summary || c.description || c.meta || (Array.isArray(c.lines) ? c.lines.join(' · ') : ''),
        image: c.image,
      }));
      previewTitle.textContent = data.title;
      previewSubtitle.textContent = data.subtitle || 'Senarai kad pada halaman terpilih.';
      renderPreviewCards(cards, true, isNoticePage, actionMode);
    }

    function renderPreviewCards(cards, allowEdit = false, isNoticeLayout = false, actionMode = 'page') {
      previewCards.innerHTML = '';
      previewCount.textContent = `${cards.length} kad`;
      if (!cards.length) {
        previewEmpty.classList.remove('hidden');
        return;
      }
      previewEmpty.classList.add('hidden');
      cards.forEach((card, idx) => {
        const el = document.createElement('article');

        if (isNoticeLayout) {
          const imgSrc = card.image || fallbackImages[idx % fallbackImages.length];
          const imageBlock = imgSrc ? `
            <div class="sm:w-40 h-40 sm:h-auto shrink-0 relative overflow-hidden">
              <div class="absolute inset-0 bg-cover bg-center transition-transform duration-700 group-hover:scale-105" style="background-image: url('${imgSrc}')"></div>
              <div class="absolute top-3 left-3 sm:hidden">
                <span class="px-2 py-1 bg-white/90 backdrop-blur text-primary rounded-lg text-[11px] font-bold shadow-sm">${card.tag || ''}</span>
              </div>
            </div>
          ` : '';

          el.className = 'group bg-white rounded-2xl overflow-hidden border border-stone-200 hover:shadow-lg hover:shadow-primary/5 transition-all duration-300 flex flex-col sm:flex-row';
          el.innerHTML = `
            ${imageBlock}
            <div class="flex-1 p-5 flex flex-col justify-center gap-2">
              <div class="flex items-center gap-3 text-[11px] font-medium text-text-main/70">
                ${card.date ? `<span class="text-eucalyptus font-bold text-sm">${card.date}</span>` : ''}
                ${card.date ? '<span class="w-1 h-1 rounded-full bg-[#cbd5e1]"></span>' : ''}
                <span class="text-[#60857d] uppercase tracking-wider">${card.tag || ''}</span>
              </div>
              <h3 class="text-lg font-bold text-text-main group-hover:text-primary transition-colors">${card.title || ''}</h3>
              <p class="text-[#60857d] text-sm leading-relaxed line-clamp-2">${card.summary || ''}</p>
              ${allowEdit ? `
                <div class="flex flex-wrap items-center gap-2 pt-3 text-xs font-bold">
                  <button class="px-3 py-1.5 rounded-lg border border-primary/30 text-primary hover:bg-primary/5 transition" data-action="${actionMode === 'notice' ? 'edit-notice' : 'edit-page'}" data-id="${card.id || ''}">Edit</button>
                  <button class="px-3 py-1.5 rounded-lg border border-red-200 text-red-600 hover:bg-red-50 transition" data-action="${actionMode === 'notice' ? 'delete-notice' : 'delete-page'}" data-id="${card.id || ''}">Padam</button>
                </div>
              ` : ''}
            </div>
          `;
        } else {
          const baseClass = 'border border-stone-200 rounded-xl p-3 bg-white shadow-sm flex flex-col gap-2 text-sm';
          el.className = `${baseClass} ${card.bg || ''}`.trim();

          const imageBlock = card.image ? `
            <div class="rounded-xl overflow-hidden border border-stone-200/70">
              <div class="aspect-[16/9] bg-center bg-cover" style="background-image: url('${card.image}')"></div>
            </div>
          ` : '';

          el.innerHTML = `
            ${imageBlock}
            <div class="flex items-start justify-between gap-3">
              <div>
                <p class="text-[11px] font-semibold uppercase tracking-widest text-text-main/60">${card.tag || ''}</p>
                <h3 class="text-base font-bold ${card.textClass || 'text-text-main'}">${card.title || ''}</h3>
              </div>
              ${card.displayDate || card.date ? `<span class="text-[11px] text-text-main/60">${card.displayDate || card.date}</span>` : ''}
            </div>
            ${card.meta ? `<p class="text-[11px] font-semibold text-primary">${card.meta}</p>` : ''}
            <p class="text-[13px] leading-5 ${card.textClass || 'text-text-main/70'}">${card.summary || ''}</p>
            ${allowEdit ? `
              <div class="flex flex-wrap items-center gap-2 pt-3 text-xs font-bold">
                <button class="px-3 py-1.5 rounded-lg border border-primary/30 text-primary hover:bg-primary/5 transition" data-action="edit-page" data-id="${card.id || ''}">Edit</button>
                <button class="px-3 py-1.5 rounded-lg border border-red-200 text-red-600 hover:bg-red-50 transition" data-action="delete-page" data-id="${card.id || ''}">Padam</button>
              </div>
            ` : ''}
          `;
        }

        // Edit/Delete actions removed with form removal.

        previewCards.appendChild(el);
      });
    }

    if (previewCards) {
      previewCards.addEventListener('click', (evt) => {
      const btn = evt.target.closest('[data-action]');
      if (!btn) return;
      const action = btn.getAttribute('data-action');
      const id = btn.getAttribute('data-id');
      if (!id) {
        showToast('ID kad tidak ditemui, data akan disegerakkan semula.', 'error');
        ensureNoticeIds();
        ensurePageCardIds(currentPage);
        setActivePage(currentPage);
        return;
      }
      if (action === 'delete-notice') {
        if (!confirm('Padam notis ini?')) return;
        deleteNoticeById(id);
      } else if (action === 'edit-notice') {
        const card = notices.find(n => n.id === id);
        if (!card) return showToast('Notis tidak ditemui.', 'error');
        openEditModal('notice', 'notis-public', {
          id: card.id,
          title: card.title,
          tag: card.category,
          rawDate: card.date,
          summary: card.summary,
          meta: card.meta,
          image: card.image,
        });
      } else if (action === 'delete-page') {
        if (!confirm('Padam kad ini dari halaman?')) return;
        deletePageCardById(currentPage, id);
      } else if (action === 'edit-page') {
        const cards = pageData[currentPage]?.cards || [];
        const card = cards.find(c => c.id === id);
        if (!card) return showToast('Kad tidak ditemui.', 'error');
        openEditModal('page', currentPage, {
          id: card.id,
          title: card.title || card.name,
          tag: card.tag || card.category || card.icon,
          rawDate: card.date,
          summary: card.summary || card.description || card.meta || (Array.isArray(card.lines) ? card.lines.join(' · ') : ''),
          meta: card.meta,
          image: card.image,
        });
      }
      });
    }

    // Listeners are bound inside ensureEditModalReady()

    function formatDate(dateStr) {
      if (!dateStr) return '';
      const d = new Date(dateStr);
      return d.toLocaleDateString('ms-MY', { year: 'numeric', month: 'short', day: 'numeric' });
    }
  </script>
</body>
</html>
